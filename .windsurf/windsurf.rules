# WINDSURF BASE RULES ‚Äì Asystent Radnego

## Rola

Dzia≈Çasz jako **Senior Software Architect & Backend Engineer**.

Tworzysz i utrzymujesz **Agenta AI Windsurf** (analiza prawna, bud≈ºetowa, por√≥wnawcza JST).

System opiera siƒô wy≈ÇƒÖcznie na **publicznych, bezp≈Çatnych API i scraperach** (ISAP, CBOSA, RIO, BIP, Dzienniki Urzƒôdowe).

**Brak MCP. Brak zgadywania prawa.**

---

## 0. PERSONALIZACJA AGENTA (GLOBALNE ZASADY)

### 0.1 Dane u≈ºytkownika z `user_locale_settings`

**ZAWSZE** pobieraj dane lokalne u≈ºytkownika przed rozpoczƒôciem pracy:

```typescript
// Tabela: user_locale_settings
interface UserLocaleSettings {
  user_id: string;
  language: string; // "pl" | "en"
  timezone: string; // "Europe/Warsaw"
  date_format: string; // "DD.MM.YYYY"
  municipality: string; // Gmina/Miasto (np. "Drawno")
  voivodeship: string; // Wojew√≥dztwo (np. "zachodniopomorskie")
  council_name: string; // Pe≈Çna nazwa rady (np. "Rada Miejska w Drawnie")
  bip_url: string; // Adres BIP gminy
}
```

### 0.2 Zwracanie siƒô do u≈ºytkownika

**Model AI ZAWSZE:**

- Pobiera imiƒô u≈ºytkownika z `user_profiles.full_name`
- Zwraca siƒô do u≈ºytkownika **po imieniu** (pierwsza czƒô≈õƒá `full_name`)
- Przyk≈Çad: "Cze≈õƒá Marcin, przeanalizowa≈Çem dokument..."

```typescript
// WyciƒÖgnij imiƒô z pe≈Çnego imienia i nazwiska
const firstName = profile.full_name?.split(" ")[0] || "";
```

### 0.3 Kontekst lokalny

**System ZAWSZE ustawia siƒô do pracy na rzecz samorzƒÖdu u≈ºytkownika:**

- Priorytetyzuje ≈∫r√≥d≈Ça z gminy/powiatu u≈ºytkownika
- U≈ºywa `council_name` w kontek≈õcie odpowiedzi
- Automatycznie przeszukuje BIP u≈ºytkownika (`bip_url`)
- Zna wojew√≥dztwo i specyfikƒô regionalnƒÖ

### 0.4 Implementacja w chat.ts

```typescript
// Pobierz dane lokalne
const { data: localeSettings } = await supabase
  .from("user_locale_settings")
  .select("*")
  .eq("user_id", userId)
  .single();

// Buduj kontekst z priorytetem dla danych lokalnych
const systemPromptContext = {
  municipalityName:
    localeSettings?.municipality || localeSettings?.council_name,
  councilName: localeSettings?.council_name,
  voivodeship: localeSettings?.voivodeship,
  bipUrl: localeSettings?.bip_url,
  userName: profile?.full_name,
  userPosition: profile?.position,
};
```

---

## Zasady nadrzƒôdne

1. **Najpierw architektura** ‚Üí potem kod.
2. **Separacja odpowiedzialno≈õci**: `ingest ‚Üí parse ‚Üí analyze ‚Üí diff ‚Üí output`
3. **Kod produkcyjny**, audytowalny, testowalny.
4. **AI wspiera** klasyfikacjƒô i podobie≈Ñstwo, **nie podejmuje decyzji prawnych**.

---

## 1. KONFIGURACJA DYNAMICZNA (ZAKAZ HARDCODOWANIA)

### 1.1 Konfiguracja API

**ZAWSZE** pobieraj konfiguracjƒô z `api_configurations` przez `AIConfigResolver`:

```typescript
// ‚úÖ POPRAWNIE - dynamiczna konfiguracja
const configResolver = new AIConfigResolver(supabase, userId);
const config = await configResolver.resolve();

// ‚ùå B≈ÅƒòDNIE - hardcoded
const openai = new OpenAI({ apiKey: "sk-..." });
const model = "gpt-4o";
```

### 1.2 Providery AI

Nigdy nie hardcoduj nazw provider√≥w ani modeli:

```typescript
// ‚úÖ POPRAWNIE
const provider = config.providers.get(functionType);
const model = provider.modelName;

// ‚ùå B≈ÅƒòDNIE
const model = "gpt-4o-mini";
const provider = "openai";
```

### 1.3 Providery Semantic Search

U≈ºywaj dynamicznej listy z `DeepResearchService`:

```typescript
// ‚úÖ POPRAWNIE - dynamiczne providery
const providers = await deepResearch.getAvailableProviders();
// Zwraca: ['exa', 'brave', 'tavily', 'serper'] na podstawie api_configurations

// ‚ùå B≈ÅƒòDNIE
const providers = ["exa"]; // hardcoded
```

---

## 2. DEEP RESEARCH - WYSZUKIWANIE DOKUMENTACJI

### 2.1 Zasada u≈ºycia

**ZAWSZE** u≈ºywaj `DeepResearchService` do wyszukiwania zewnƒôtrznych informacji:

```typescript
// ‚úÖ POPRAWNIE
const deepResearch = new DeepResearchService(supabase, userId);
const results = await deepResearch.research({
  query: "ustawa o samorzƒÖdzie gminnym art. 18",
  researchType: "legal",
  depth: "standard"
});

// ‚ùå B≈ÅƒòDNIE - bezpo≈õrednie wywo≈Çanie API
const response = await fetch("https://api.exa.ai/search", {...});
```

### 2.2 Dynamiczne providery w DeepResearch

DeepResearch automatycznie u≈ºywa provider√≥w z `api_configurations`:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DeepResearchService                                     ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ ExaProvider      (je≈õli klucz w DB)               ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ BraveProvider    (je≈õli klucz w DB)               ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ TavilyProvider   (je≈õli klucz w DB)               ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ SerperProvider   (je≈õli klucz w DB)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.3 Typy wyszukiwa≈Ñ

```typescript
type ResearchType = "legal" | "budget" | "general" | "session";
type ResearchDepth = "quick" | "standard" | "deep";
```

---

## 3. CHAT AI - PRZEP≈ÅYW PRZETWARZANIA ZAPYTA≈É

### 3.1 Algorytm obs≈Çugi zapytania

```
ZIDENTYFIKUJ ‚Üí WYSZUKAJ ‚Üí SPRAWD≈π AKTUALNO≈öƒÜ ‚Üí PRZEANALIZUJ ‚Üí WYKONAJ
```

```typescript
async function handleChatMessage(message: string, userId: string) {
  // 1. ZIDENTYFIKUJ - wykryj intencjƒô i wymagane dane
  const intent = await detectIntent(message);
  const sessionIntent = documentQueryService.detectSessionIntent(message);

  // 2. WYSZUKAJ - najpierw RAG, potem external
  let documents = await ragSearch(message, userId);

  // 3. SPRAWD≈π AKTUALNO≈öƒÜ - je≈õli brak lub nieaktualne, zdobƒÖd≈∫
  if (needsFreshData(intent, documents)) {
    const externalResults = await deepResearch.research({
      query: message,
      researchType: intent.type,
    });
    documents = [...documents, ...externalResults];
  }

  // 4. PRZEANALIZUJ - u≈ºyj odpowiednich silnik√≥w
  const analysis = await analyzeWithRelevantEngine(intent, documents);

  // 5. WYKONAJ - wygeneruj odpowied≈∫
  return generateResponse(analysis, documents);
}
```

### 3.2 Dostƒôpne narzƒôdzia do zdobywania informacji

| Narzƒôdzie                 | U≈ºycie                   | Modu≈Ç                                         |
| ------------------------- | ------------------------ | --------------------------------------------- |
| **RAG Search**            | Dokumenty u≈ºytkownika    | `DocumentQueryService`                        |
| **Session Discovery**     | Sesje rady, protoko≈Çy    | `SessionDiscoveryService`                     |
| **Deep Research**         | Zewnƒôtrzne ≈∫r√≥d≈Ça prawne | `DeepResearchService`                         |
| **Legal Search**          | ISAP, CBOSA, Dzienniki   | `LegalSearchApi`                              |
| **Budget Analysis**       | Analiza bud≈ºetowa        | `BudgetAnalysisEngine`                        |
| **Legal Reasoning**       | Analiza prawna           | `LegalReasoningEngine`                        |
| **Intelligence Scraping** | Dane z BIP, YouTube      | `IntelligentScraper`, `ScraperV2`             |
| **Audio Transcription**   | Transkrypcja nagra≈Ñ      | `AudioTranscriber`, `TranscriptionJobService` |
| **YouTube Download**      | Pobieranie audio         | `YouTubeDownloader`, `YouTubeSessionService`  |

### 3.3 Hierarchia wyszukiwania

```
1. RAG (lokalne dokumenty u≈ºytkownika)
   ‚Üì je≈õli brak
2. Session Discovery (sesje rady)
   ‚Üì je≈õli brak
3. Deep Research (Exa, Brave, Tavily, Serper)
   ‚Üì je≈õli potrzeba prawna
4. Legal Search API (ISAP, CBOSA)
   ‚Üì je≈õli potrzeba bud≈ºetowa
5. Budget Analysis Engine
```

---

## 4. AUTO-TRANSKRYPCJA YOUTUBE I AUDIO

### 4.1 Kiedy wykonywaƒá transkrypcjƒô

Gdy DeepResearch znajdzie ≈∫r√≥d≈Ça audio/video (YouTube, nagrania), AI ocenia relevancjƒô:

```typescript
// Przep≈Çyw auto-transkrypcji
if (isAudioVideoSource(result.url) && isRelevantForCouncil(result)) {
  // 1. Pobierz audio
  const audio = await youtubeDownloader.downloadAudio(result.url);

  // 2. Wykonaj transkrypcjƒô
  const transcription = await audioTranscriber.transcribe(audio, {
    language: "pl",
    model: config.transcriptionModel, // dynamiczny model z konfiguracji
  });

  // 3. Analiza sentymentu
  const sentiment = await analyzeSentiment(transcription.text);

  // 4. Dodaj do RAG
  await addToRAG({
    content: transcription.text,
    source_url: result.url,
    document_type: "transcription",
    metadata: {
      sentiment: sentiment,
      duration: audio.duration,
      speakers: transcription.speakers,
    },
  });
}
```

### 4.2 Kryteria relevancji dla transkrypcji

```typescript
function isRelevantForCouncil(result: SearchResult): boolean {
  const relevantPatterns = [
    /sesja.*rady/i,
    /posiedzenie.*komisji/i,
    /rada\s+(gminy|miejska|powiatu)/i,
    /obrady/i,
    /transmisja.*sesji/i,
    /nagranie.*sesji/i,
    /burmistrz|w√≥jt|starosta/i,
    /informacja\s+publiczna/i,
  ];

  return relevantPatterns.some(
    (p) => p.test(result.title) || p.test(result.description)
  );
}
```

### 4.3 Analiza sentymentu transkrypcji

```typescript
interface SentimentAnalysis {
  overall: "positive" | "neutral" | "negative" | "mixed";
  score: number; // -1.0 do 1.0
  topics: Array<{
    topic: string;
    sentiment: string;
    confidence: number;
  }>;
  speakers?: Array<{
    speaker: string;
    sentiment: string;
    statements: number;
  }>;
}

// Dodawaj do RAG razem z sentymentem
await processedDocuments.insert({
  content: transcription.text,
  sentiment_analysis: sentimentAnalysis,
  document_type: "session_transcription",
  keywords: extractKeywords(transcription.text),
});
```

### 4.4 Modu≈Çy transkrypcji

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ YouTubeDownloader                                       ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Pobiera audio z YouTube                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ AudioPreprocessor                                       ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Normalizacja, dzielenie na chunki                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ AudioTranscriber                                        ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Whisper API (dynamiczny model z konfiguracji)     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ AudioAnalyzer                                           ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Detekcja m√≥wc√≥w, analiza jako≈õci                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TranscriptionJobService                                 ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Kolejkowanie i zarzƒÖdzanie zadaniami              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 5. INTELLIGENCE SCRAPING

### 5.1 Filtrowanie AI (checkDocumentRelevance)

Ka≈ºdy scrapowany dokument przechodzi przez filtr relevancji:

```typescript
const isRelevant = await checkDocumentRelevance(
  openai,
  content.title,
  content.raw_content,
  content.url
);

if (!isRelevant) {
  console.log(`[Scraper] Pomijam nieistotny dokument: ${content.title}`);
  continue;
}
```

### 5.2 Wzorce do odrzucenia

```typescript
const irrelevantPatterns = [
  /howyoutubeworks/i,
  /privacy.*policy/i,
  /terms.*service/i,
  /business.*model/i,
  /creator.*economy/i,
];
```

### 5.3 S≈Çowa kluczowe do akceptacji

```typescript
const relevantKeywords = [
  "sesja",
  "rada",
  "gmina",
  "uchwa≈Ça",
  "protok√≥≈Ç",
  "burmistrz",
  "w√≥jt",
  "radny",
  "bud≈ºet",
  "bip",
  "urzƒÖd",
];
```

---

## 6. ZAKRES FUNKCJONALNY

### 6.1 Legal Analysis

- Delegacje ustawowe
- Kompetencje organu
- Sprzeczno≈õci z prawem
- Modu≈Çy: `LegalReasoningEngine`, `LegalSearchApi`

### 6.2 Budget Analysis

- Klasyfikacja bud≈ºetowa
- Przesuniƒôcia ≈õrodk√≥w
- Ryzyka WPF/RIO
- Modu≈Ç: `BudgetAnalysisEngine`

### 6.3 Diff Engine

- Zmiany **semantyczne**, nie tylko tekstowe
- Modu≈Ç: `DocumentAnalysisService`

### 6.4 Benchmark

- Por√≥wnania miƒôdzy JST
- Modu≈Ç: `DeepResearchService` + `DocumentQueryService`

---

## 7. INFRASTRUKTURA

### 7.1 Baza danych

- **Supabase PostgreSQL** - jedyna baza danych
- Tabele: `api_configurations`, `processed_documents`, `data_sources`, `scraped_content`

### 7.2 Cache i kolejki

- **Docker Redis** - cache i kolejki zada≈Ñ

### 7.3 Struktura projektu

```
apps/
‚îú‚îÄ‚îÄ api/          # Backend Express
‚îú‚îÄ‚îÄ frontend/     # Next.js
‚îî‚îÄ‚îÄ worker/       # Background jobs
packages/
‚îî‚îÄ‚îÄ shared/       # Typy wsp√≥≈Çdzielone
```

---

## 8. REGU≈ÅY KODOWANIA

### 8.1 Deterministyczno≈õƒá

- Identyczny input ‚Üí identyczny output
- Decyzje muszƒÖ byƒá replayable z log√≥w
- Brak randomowo≈õci bez explicit seed

### 8.2 Separacja

```
Prompt ‚â† Logic
Agent ‚â† Orchestrator
Model ‚â† Memory
```

### 8.3 Fail Fast

- Abort przy niesp√≥jno≈õci
- Raportuj dok≈Çadny pow√≥d b≈Çƒôdu
- **Nigdy nie zgaduj**

### 8.4 Observability

- Loguj: input, decision, output, execution time
- Logi muszƒÖ pozwalaƒá na pe≈Çny replay decyzji

### 8.5 No Hallucinations

- BrakujƒÖce dane ‚Üí UNKNOWN lub popro≈õ o wyja≈õnienie
- **Nigdy nie wymy≈õlaj fakt√≥w ani logiki**

---

## 9. DOKUMENTACJA - OBOWIƒÑZKOWE ODCZYTYWANIE

### 9.1 Przed rozpoczƒôciem ka≈ºdej sesji

**ZAWSZE** na poczƒÖtku pracy odczytaj kluczowe pliki dokumentacji:

```
1. docs/architecture.md     ‚Üí Zrozum aktualnƒÖ architekturƒô
2. docs/todo.md             ‚Üí Sprawd≈∫ co jest do zrobienia
3. docs/change_log.md       ‚Üí Poznaj ostatnie zmiany (top 50 linii)
4. .windsurf/base_rules.md  ‚Üí Przypomnij zasady budowania
```

### 9.2 ObowiƒÖzkowa aktualizacja po zmianach

Po ka≈ºdej znaczƒÖcej zmianie w kodzie **AKTUALIZUJ**:

| Plik                   | Kiedy aktualizowaƒá                |
| ---------------------- | --------------------------------- |
| `docs/change_log.md`   | Po ka≈ºdej zmianie funkcjonalno≈õci |
| `docs/todo.md`         | Po dodaniu/uko≈Ñczeniu zadania     |
| `docs/architecture.md` | Po zmianie struktury/modu≈Ç√≥w      |

### 9.3 Format wpisu w change_log.md

```markdown
## RRRR-MM-DD - Kr√≥tki tytu≈Ç zmiany

### Opis

Co zosta≈Ço zmienione i dlaczego.

### Zmodyfikowane pliki

- `path/to/file.ts` - opis zmiany

### Status

‚úÖ Uko≈Ñczone / üîÑ W trakcie / ‚è≥ Do wykonania
```

### 9.4 Format wpisu w todo.md

```markdown
## Do wykonania (priorytet)

### üî¥ Krytyczne

- [ ] Zadanie 1

### üü† Wa≈ºne

- [ ] Zadanie 2

### üîµ Normalne

- [ ] Zadanie 3

## Uko≈Ñczone

- [x] Zadanie uko≈Ñczone (data)
```

### 9.5 Pliki dokumentacji

Przechowuj i aktualizuj w `/docs`:

- `architecture.md` - architektura systemu, modu≈Çy, przep≈Çywy
- `todo.md` - zadania do wykonania z priorytetami
- `change_log.md` - historia zmian (najnowsze na g√≥rze)
- `docker.md` - infrastruktura Docker

---

## 10. PRIME RULE

**AI agent jest komponentem systemu, nie u≈ºytkownikiem.**

Zawsze pisz w jƒôzyku polskim (chyba ≈ºe niemo≈ºliwe - wtedy po angielsku).

DodajƒÖc lub naprawiajƒÖc funkcje, **zawsze szukaj powiƒÖza≈Ñ** i wykonuj wymagane zmiany we wszystkich zale≈ºnych miejscach aplikacji.

Zapisuj swoje kroki w pliku `/docs/change_log.md`

---

## 11. OBSERWOWALNO≈öƒÜ I OPERACJE (DEVOPS)

### 11.1 Trace ID i logowanie

- Ka≈ºdy request (API, worker) musi generowaƒá `traceId` i logowaƒá decyzje narzƒôdzi (`tool=deep_research`, `tool=rag_search`, itd.).
- Logi majƒÖ format JSON; w dev mo≈ºna u≈ºywaƒá `pino-pretty`, w produkcji wysy≈Çamy je do centralnego systemu (np. Supabase logs / Loki).
- B≈Çƒôdy MUSZƒÑ zawieraƒá `traceId` w odpowiedzi (`reply.code(500).send({ errorId: traceId, ... })`), aby u≈ºytkownik m√≥g≈Ç zg≈Çosiƒá problem.

### 11.2 Monitorowanie pipeline‚Äôu

- Worker publikuje metryki job√≥w (czas start/stop, typ, status) do Redis/Prometheus.
- Dashboard operacyjny powinien pokazywaƒá: liczbƒô dokument√≥w w ingest, b≈Çƒôdy OCR, b≈Çƒôdy DeepResearch, kolejkƒô BullMQ.
- W razie awarii jobu zapisujemy `failure_reason`, `retry_count`, `last_payload`.

### 11.3 Konfiguracja ≈õrodowisk

- `.env` osobno dla `apps/api`, `apps/frontend`, `apps/worker`. Sekrety przechowujemy poza repo (np. Doppler, 1Password).
- Wszystkie klucze API (OpenAI, Exa, itp.) sƒÖ wersjonowane w tabeli `api_configurations` i szyfrowane (base64). Brak klucza = provider offline.
- Supabase jest **single source of truth** ‚Äì migracje SQL w `apps/api/migrations` MUSZƒÑ byƒá odpalone rƒôcznie (Supabase SQL Editor) i opisane w `docs/change_log.md`.

### 11.4 Testy i release

- Minimalny zestaw test√≥w uruchamiany przed releasem: lint, typy, smoke test API `/health`, test zapytania RAG, test DeepResearch (mock providers).
- Deployment lokalny: `npm run dev` (uruchamia API, frontend, worker). W CI preferujemy docker-compose (`infra/docker-compose.yml`) z profilami `api`, `frontend`, `worker`.

### 11.5 Alerty

- Krytyczne alerty DevOps: brak dostƒôpu do Supabase, b≈Çƒôdy 5xx na `/api/research`, rosnƒÖca kolejka BullMQ > 50 job√≥w, brak wolumenu w ingestion przez 24h.
- Alertuje siƒô odpowiedzialnego in≈ºyniera + kana≈Ç #windsurf-ops.
